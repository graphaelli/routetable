<!doctype html>
<html>
  <head>
    <title>Route table</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.1/leaflet-geocoder-mapzen.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.1/leaflet-geocoder-mapzen.js"></script>
    <style>
     .rt-leaflet-pelias-control-init {
	 position: fixed;
	 left: 30%;
	 top: 80px;
     }

     #map {
	 height: 100%;
	 width: 70%;
	 position: absolute;
     }
     html,body{margin: 0; padding: 0}
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="rt"></div>
    <script>
      src = null;
      dst = null;

     function getRouteTable() {
	 if (src && dst) {
	     console.log('fetching route table between ', src, dst);
	     var rt = document.getElementById('rt');
	     rt.innerHTML = 'fetching routes to ' + dst.feature.properties.label;
             var xhr = new XMLHttpRequest();
             xhr.open('GET', 'http://localhost:5000/rt/' + src.latlng.lat + ',' + src.latlng.lng + ';'  + dst.latlng.lat + ',' + dst.latlng.lng);
             xhr.send(null);
             xhr.onreadystatechange = function () {
		 var HEADERS_RECEIVED = 2;
		 var LOADING = 3;
		 var DONE = 4;
		 var OK = 200;
		 switch(xhr.readyState) {
		     case HEADERS_RECEIVED:
		     case LOADING:
			 rt.innerHTML = '<p>loading routes to ' + dst.feature.properties.label + '</p>';
			 break;
		     case DONE:
			 if (xhr.status === OK) {
			     rt.innerHTML = xhr.responseText;
			 } else {
			     rt.innerHTML = '<p>error!</p>';
			     console.log(xhr.responseText);
			 }
			 break;
		 }
	     }
	 }
     }

     var map = L.map('map').setView([39.981173, -75.275333], 13);
     L.tileLayer('http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png', {
	 attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
	 maxZoom: 18,
      }).addTo(map);

     var geocoder_options = {
	 bounds: L.latLngBounds(L.latLng(39.629909, -75.730557), L.latLng(40.337686, -74.473703)),
	 expanded: true,
	 focus: true,
	 panToPoint: false,
	 placeholder: 'Where to?',
     };
     var geocoder = L.control.geocoder('search-gN5bntm', geocoder_options).addTo(map);
     geocoder.getContainer().classList.add('rt-leaflet-pelias-control-init');
     geocoder.on('select', function (e) {
	 dst = e;
         console.log('Destination set:', e);
	 getRouteTable();

	 geocoder.getContainer().classList.remove('rt-leaflet-pelias-control-init');
	 geocoder.collapse();
     });

     var popup = L.popup();
     function onMapClick(e) {
	 popup
        .setLatLng(e.latlng)
        .setContent("Trip start set to " + e.latlng.toString())
        .openOn(map);
	src = e;
        getRouteTable();
     };
     map.on('click', onMapClick);
    </script>
  </body>
</html>
